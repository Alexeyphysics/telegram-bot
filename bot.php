<?php

require __DIR__ . '/vendor/autoload.php';

use Telegram\Bot\Api;
use Dotenv\Dotenv;
use Telegram\Bot\Keyboard\Keyboard;

// --- Константы состояний пользователя ---
define('STATE_DEFAULT', 0);
// Регистрация
define('STATE_AWAITING_NAME', 1);
define('STATE_AWAITING_EMAIL', 2);
define('STATE_AWAITING_PASSWORD', 3);
// ОБЩИЕ СОСТОЯНИЯ для выбора упражнения
define('STATE_SELECTING_MUSCLE_GROUP', 11);
define('STATE_SELECTING_EXERCISE_TYPE', 12);
define('STATE_SELECTING_EXERCISE', 13);
// Состояния ТОЛЬКО для записи тренировки
define('STATE_LOGGING_TRAINING_MENU', 10); // Находимся в меню "Добавить/Завершить/Назад"
define('STATE_AWAITING_REPS', 14);
define('STATE_AWAITING_WEIGHT', 15);
// Состояния для БЖУ продуктов
define('STATE_AWAITING_PRODUCT_NAME_SAVE', 30);
define('STATE_AWAITING_PRODUCT_PROTEIN', 31);
define('STATE_AWAITING_PRODUCT_FAT', 32);
define('STATE_AWAITING_PRODUCT_CARBS', 33);
define('STATE_AWAITING_PRODUCT_KCAL', 34);
define('STATE_AWAITING_SAVE_CONFIRMATION', 35);
define('STATE_AWAITING_PRODUCT_NAME_DELETE', 40);
define('STATE_AWAITING_DELETE_CONFIRMATION', 41);
define('STATE_AWAITING_PRODUCT_NAME_SEARCH', 50);
// Состояния для Дневника Питания
define('STATE_DIARY_MENU', 60); // В главном меню Дневника
define('STATE_AWAITING_ADD_MEAL_OPTION', 61);
define('STATE_AWAITING_SEARCH_PRODUCT_NAME_ADD', 62);
define('STATE_AWAITING_GRAMS_SEARCH_ADD', 63);
define('STATE_AWAITING_ADD_MEAL_CONFIRM_SEARCH', 64);
define('STATE_AWAITING_GRAMS_MANUAL_ADD', 65);
define('STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD', 66);
define('STATE_AWAITING_PROTEIN_MANUAL_ADD', 67);
define('STATE_AWAITING_FAT_MANUAL_ADD', 68);
define('STATE_AWAITING_CARBS_MANUAL_ADD', 69);
define('STATE_AWAITING_KCAL_MANUAL_ADD', 70);
define('STATE_AWAITING_ADD_MEAL_CONFIRM_MANUAL', 71);
define('STATE_AWAITING_DATE_DELETE_MEAL', 80);
define('STATE_AWAITING_PRODUCT_NAME_DELETE_MEAL', 81);
define('STATE_AWAITING_GRAMS_DELETE_MEAL', 82);
define('STATE_AWAITING_DELETE_MEAL_CONFIRM', 83);
define('STATE_AWAITING_DATE_VIEW_MEAL', 90);


// Загружаем .env файл
$dotenv = Dotenv::createImmutable(__DIR__);
$dotenv->load();

$telegram = new Api(env('TELEGRAM_BOT_TOKEN', ''));
$updateId = 0;

// --- Пути к файлам для хранения данных ---
$userDataFile = __DIR__ . '/bot_users.json';
$userProductsFile = __DIR__ . '/bot_products.json';
$diaryFile = __DIR__ . '/bot_diary.json';

// --- Загрузка данных пользователей из файла ---
$userStates = [];
$userData = [];
if (file_exists($userDataFile)) { $jsonContent = file_get_contents($userDataFile); if (!empty($jsonContent)) { $decodedData = json_decode($jsonContent, true); if (json_last_error() === JSON_ERROR_NONE && is_array($decodedData)) { $userData = $decodedData; echo "User data loaded from {$userDataFile}\n"; } else { echo "Error decoding JSON in {$userDataFile}. Starting fresh.\n"; $userData = []; } } else { echo "User data file is empty. Starting fresh.\n"; $userData = []; } } else { echo "User data file not found ({$userDataFile}), starting fresh.\n"; }

// --- Загрузка данных продуктов из файла ---
$userProducts = [];
if (file_exists($userProductsFile)) { $jsonContent = file_get_contents($userProductsFile); if (!empty($jsonContent)) { $decodedData = json_decode($jsonContent, true); if (json_last_error() === JSON_ERROR_NONE && is_array($decodedData)) { $userProducts = $decodedData; echo "User products loaded from {$userProductsFile}\n"; } else { echo "Error decoding JSON in {$userProductsFile}. Starting fresh.\n"; $userProducts = []; } } else { echo "User products file is empty. Starting fresh.\n"; $userProducts = []; } } else { echo "User products file not found ({$userProductsFile}), starting fresh.\n"; }

// --- Загрузка данных дневника ---
$diaryData = [];
if (file_exists($diaryFile)) { $jsonContent = file_get_contents($diaryFile); if (!empty($jsonContent)) { $decodedData = json_decode($jsonContent, true); if (json_last_error() === JSON_ERROR_NONE && is_array($decodedData)) { $diaryData = $decodedData; echo "Diary data loaded from {$diaryFile}\n"; } else { echo "Error decoding JSON in {$diaryFile}. Starting fresh.\n"; $diaryData = []; } } else { echo "Diary diary file is empty. Starting fresh.\n"; $diaryData = []; } } else { echo "Diary data file not found ({$diaryFile}), starting fresh.\n"; }

// --- Временное хранилище (остальные) ---
$userSelections = [];
$currentTrainingLog = [];

// --- Структура упражнений ---
$exercises = [ 'Ноги и Ягодицы' => [ 'Приседания' => [ 'Приседания со штангой на спине', 'Приседания с гантелями', 'Приседания в тренажере Смита', 'Болгарские сплит-приседания', 'Приседания на одной ноге', 'Приседания с весом над головой', ], 'Выпады' => [ 'Выпады вперед', 'Выпады назад', 'Выпады в сторону', 'Выпады с гантелями/штангой', 'Ходьба выпадами', ], 'Тяги' => [ 'Становая тяга (классическая, сумо, румынская)', 'Тяга штанги в наклоне (к поясу)', ], 'Жим ногами' => [ 'Жим ногами в платформе (под разными углами)', 'Жим одной ногой', 'Жим ногами с узкой постановкой стоп', 'Жим ногами с широкой постановкой стоп', 'Жим ногами с носками, развернутыми наружу', 'Жим ногами с носками, развернутыми внутрь', 'Жим ногами с высоким положением стоп на платформе', 'Жим ногами с низким положением стоп на платформе', 'Жим ногами в тренажере Гаккеншмидта', ], 'Разгибания/Сгибания ног' => [ 'Разгибание ног в тренажере', 'Сгибание ног в тренажере', ], 'Ягодичный мостик' => [ 'Ягодичный мостик со штангой/гантелей', 'Ягодичный мостик на одной ноге', ], 'Махи ногами' => [ 'Махи ногой назад в тренажере', 'Махи ногой в сторону в тренажере', ], 'Икры' => [ 'Подъемы на носки стоя', 'Подъемы на носки сидя', ], ], 'Спина' => [ 'Подтягивания' => [ 'Подтягивания широким хватом', 'Подтягивания в гравитроне', ], 'Тяги' => [ 'Тяга верхнего блока к груди', 'Тяга нижнего блока к поясу сидя', 'Тяга гантели в наклоне одной рукой', 'Тяга Т-грифа', ], 'Гиперэкстензия' => [ 'Гиперэкстензия с весом', 'Гиперэкстензия под углом 45 градусов', ], 'Шраги' => [ 'Шраги в тренажере Смита', 'Шраги с гантелями сидя', ], ], 'Грудь' => [ 'Жим лежа' => [ 'Жим штанги лежа', 'Жим гантелей на наклонной скамье головой вниз, узким хватом', 'Жим лежа узким хватом', ], 'Разведения рук' => [ 'Разведение гантелей лежа', 'Разведение рук в тренажере "бабочка"', ], 'Отжимания' => [ 'Отжимания от пола', 'Отжимания на брусьях (с акцентом на грудь)', 'Отжимания с ногами на возвышении', ], 'Кроссовер' => [ 'Сведение рук в кроссовере сверху вниз', 'Сведение рук в кроссовере снизу вверх', ], ], 'Плечи' => [ 'Жим' => [ 'Жим штанги стоя (армейский жим)', 'Жим штанги сидя', 'Жим гантелей стоя/сидя', 'Жим Арнольда', ], 'Подъемы' => [ 'Подъемы гантелей перед собой', 'Подъемы гантелей в стороны', 'Подъемы гантелей в стороны в наклоне', 'Кубинский жим', ], 'Тяги' => [ 'Тяга штанги к подбородку', ], ], 'Руки (Бицепс и Трицепс)' => [ 'Бицепс' => [ 'Сгибание рук со штангой стоя', 'Сгибание рук с гантелями стоя/сидя', 'Молотки', 'Сгибание рук на скамье Скотта', 'Сгибание рук в тренажере', 'Сгибание рук на нижнем блоке', ], 'Трицепс' => [ 'Французский жим лежа/сидя (со штангой/гантелями)', 'Разгибание рук на верхнем блоке (с канатной рукоятью, прямой рукоятью)', 'Отжимания на брусьях (с акцентом на трицепс)', 'Разгибание руки с гантелью из-за головы', 'Отжимания узким хватом от пола', 'Разгибания из-за головы на верхнем блоке', ], ], 'Пресс' => [ 'Скручивания' => [ 'Скручивания на полу', 'Скручивания на наклонной скамье', 'Обратные скручивания (подъем ног)', 'Скручивания с поворотом корпуса', 'Скручивания на фитболе', 'Боковые скручивания', ], 'Подъемы' => [ 'Подъем ног в висе', 'Подъем коленей к груди в висе/на тренажере', '"V-образные" подъемы (одновременный подъем ног и корпуса)', 'Подъемы ног на римском стуле', ], 'Планка' => [ 'Планка (классическая, боковая, на предплечьях)', 'Планка с поднятием руки/ноги', 'Динамическая планка (переход из планки на предплечьях в планку на прямых руках)', ], ], ];

// --- Клавиатуры ---
$keyboard = Keyboard::make()->row([ Keyboard::button(['text' => 'Тренировки']), Keyboard::button(['text' => 'Питание']), ])->row([ Keyboard::button(['text' => 'Аккаунт']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardTrainMenu = Keyboard::make()->row([ Keyboard::button(['text' => 'Записать тренировку']), ])->row([ Keyboard::button(['text' => 'Посмотреть прогресс в упражнениях']), ])->row([ Keyboard::button(['text' => 'Вывести отстающие группы мышц']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardNutrition = Keyboard::make()->row([ Keyboard::button(['text' => 'Дневник']), ])->row([ Keyboard::button(['text' => 'БЖУ продуктов']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardAccount = Keyboard::make()->row([ Keyboard::button(['text' => 'Вывести имя и почту']), ])->row([ Keyboard::button(['text' => 'Сменить аккаунт']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardBackOnly = Keyboard::make()->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardAddExerciseMenu = Keyboard::make()->row([ Keyboard::button(['text' => 'Добавить упражнение']), ])->row([ Keyboard::button(['text' => 'Завершить запись тренировки']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardBJU = Keyboard::make()->row([ Keyboard::button(['text' => 'Сохранить информацию о продукте']), ])->row([ Keyboard::button(['text' => 'Удалить информацию о продукте']), ])->row([ Keyboard::button(['text' => 'Сохранённые продукты']), ])->row([ Keyboard::button(['text' => 'Поиск продуктов']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardConfirmYesNo = Keyboard::make()->row([ Keyboard::button(['text' => 'Да']), Keyboard::button(['text' => 'Нет']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(true);
$keyboardDiaryMenu = Keyboard::make()->row([ Keyboard::button(['text' => 'Записать приём пищи']), ])->row([ Keyboard::button(['text' => 'Удалить приём пищи']), ])->row([ Keyboard::button(['text' => 'Посмотреть рацион за дату']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);
$keyboardAddMealOptions = Keyboard::make()->row([ Keyboard::button(['text' => 'Поиск в базе знаний']), ])->row([ Keyboard::button(['text' => 'Записать БЖУ самому']), ])->row([ Keyboard::button(['text' => 'Назад']), ])->setResizeKeyboard(true)->setOneTimeKeyboard(false);

// --- Функции-хелперы ---
function generateListMessage(array $items): string { $message = ""; foreach ($items as $index => $item) { $message .= ($index + 1) . ". " . $item . "\n"; } return rtrim($message); }
function saveUserData(array $data, string $filePath): bool { $jsonContent = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); if ($jsonContent === false) { echo "Error encoding user data to JSON.\n"; return false; } $result = file_put_contents($filePath, $jsonContent); if ($result === false) { echo "Error writing user data to file: {$filePath}\n"; return false; } echo "User data saved to {$filePath}\n"; return true; }
function saveUserProducts(array $data, string $filePath): bool { foreach ($data as $chatId => $products) { if (is_array($products) && empty($products)) { $data[$chatId] = new stdClass(); } elseif(is_array($products)) { ksort($products); $data[$chatId] = $products; } } $jsonContent = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); if ($jsonContent === false) { echo "Error encoding user products to JSON.\n"; return false; } $result = file_put_contents($filePath, $jsonContent); if ($result === false) { echo "Error writing user products to file: {$filePath}\n"; return false; } echo "User products saved to {$filePath}\n"; return true; }
function saveDiaryData(array $data, string $filePath): bool { $jsonContent = json_encode($data, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE); if ($jsonContent === false) { echo "Error encoding diary data to JSON.\n"; return false; } $result = file_put_contents($filePath, $jsonContent); if ($result === false) { echo "Error writing diary data to file: {$filePath}\n"; return false; } echo "Diary data saved to {$filePath}\n"; return true; }

// --- Основной цикл бота ---
echo "Starting Telegram Bot...\n";

while (true) {
    try {
        $updates = $telegram->getUpdates(['offset' => $updateId + 1, 'timeout' => 30]);
    } catch (\Throwable $e) {
        echo "Error getting updates: " . $e->getMessage() . "\n";
        sleep(5);
        continue;
    }

    foreach ($updates as $update) {
        $updateId = $update->getUpdateId();

        if (!$update->isType('message')) continue;

        $message = $update->getMessage();
        $chatId = $message->getChat()->getId();
        $text = $message->getText();

        // Инициализация пользователя
        if (!isset($userStates[$chatId])) $userStates[$chatId] = STATE_DEFAULT;
        if (!isset($userSelections[$chatId])) $userSelections[$chatId] = [];
        if (!isset($diaryData[$chatId])) $diaryData[$chatId] = [];
        if (!isset($userProducts[$chatId])) $userProducts[$chatId] = [];

        echo "Получено сообщение: $text (Chat ID: $chatId), State: {$userStates[$chatId]}\n";

        $currentState = $userStates[$chatId];
        $currentMode = $userSelections[$chatId]['mode'] ?? null; // Для упражнений

        try {
            // --- Обработка кнопки Назад ВО ВРЕМЯ выбора/ввода данных ---
            if ($text === 'Назад') {
                // Упражнения
                if ($currentState >= STATE_SELECTING_MUSCLE_GROUP && $currentState <= STATE_AWAITING_WEIGHT) {
                    $returnState = ($currentMode === 'log') ? STATE_LOGGING_TRAINING_MENU : STATE_DEFAULT;
                    $returnKeyboard = ($currentMode === 'log') ? $keyboardAddExerciseMenu : $keyboardTrainMenu;
                    $cancelMessage = ($currentMode === 'log') ? 'Добавление упражнения отменено.' : 'Просмотр прогресса отменен.';
                    switch ($currentState) {
                        case STATE_SELECTING_MUSCLE_GROUP: $userStates[$chatId] = $returnState; unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => $cancelMessage, 'reply_markup' => $returnKeyboard]); break;
                        case STATE_SELECTING_EXERCISE_TYPE: $userStates[$chatId] = STATE_SELECTING_MUSCLE_GROUP; unset($userSelections[$chatId]['group']); $groupKeys = array_keys($exercises); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Выберите группу:\n" . generateListMessage($groupKeys), 'reply_markup' => $keyboardBackOnly]); break;
                        case STATE_SELECTING_EXERCISE: $userStates[$chatId] = STATE_SELECTING_EXERCISE_TYPE; $group = $userSelections[$chatId]['group'] ?? '???'; unset($userSelections[$chatId]['type']); $typeKeys = isset($exercises[$group]) ? array_keys($exercises[$group]) : []; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Группа: {$group}\nВыберите тип:\n" . generateListMessage($typeKeys), 'reply_markup' => $keyboardBackOnly]); break;
                        case STATE_AWAITING_REPS: $userStates[$chatId] = STATE_SELECTING_EXERCISE; $group = $userSelections[$chatId]['group'] ?? '???'; $type = $userSelections[$chatId]['type'] ?? '???'; unset($userSelections[$chatId]['exercise']); $exerciseList = isset($exercises[$group][$type]) ? $exercises[$group][$type] : []; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Тип: {$type}\nВыберите упр.:\n" . generateListMessage($exerciseList), 'reply_markup' => $keyboardBackOnly]); break;
                        case STATE_AWAITING_WEIGHT: $userStates[$chatId] = STATE_AWAITING_REPS; unset($userSelections[$chatId]['reps']); $exercise = $userSelections[$chatId]['exercise'] ?? '???'; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Упражнение: {$exercise}\nПовторения:", 'reply_markup' => $keyboardBackOnly]); break;
                    }
                    continue;
                }
                // БЖУ Продукты
                if (($currentState >= STATE_AWAITING_PRODUCT_NAME_SAVE && $currentState <= STATE_AWAITING_SAVE_CONFIRMATION) || ($currentState >= STATE_AWAITING_PRODUCT_NAME_DELETE && $currentState <= STATE_AWAITING_DELETE_CONFIRMATION) || $currentState === STATE_AWAITING_PRODUCT_NAME_SEARCH) {
                    $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]['bju_product']); unset($userSelections[$chatId]['bju_product_to_delete']);
                    $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Действие отменено.', 'reply_markup' => $keyboardBJU]);
                    continue;
                }
                 // Дневник
                if ($currentState >= STATE_AWAITING_ADD_MEAL_OPTION && $currentState <= STATE_AWAITING_DATE_VIEW_MEAL) {
                    $previousState = STATE_DEFAULT; $previousKeyboard = $keyboardNutrition; $messageText = 'Возврат в меню Питания.';
                    if ($currentState === STATE_DIARY_MENU) {}
                    elseif ($currentState === STATE_AWAITING_ADD_MEAL_OPTION) { $previousState = STATE_DIARY_MENU; $previousKeyboard = $keyboardDiaryMenu; $messageText = 'Возврат в меню Дневника.'; }
                    elseif ($currentState === STATE_AWAITING_SEARCH_PRODUCT_NAME_ADD || $currentState === STATE_AWAITING_GRAMS_MANUAL_ADD) { $previousState = STATE_AWAITING_ADD_MEAL_OPTION; $previousKeyboard = $keyboardAddMealOptions; $messageText = 'Выберите способ добавления.'; }
                    elseif ($currentState === STATE_AWAITING_GRAMS_SEARCH_ADD || $currentState === STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD) { if (isset($userSelections[$chatId]['diary_entry']['search_name'])) { $previousState = STATE_AWAITING_SEARCH_PRODUCT_NAME_ADD; $messageText = 'Название продукта для поиска:'; $previousKeyboard = $keyboardBackOnly; } else { $previousState = STATE_AWAITING_GRAMS_MANUAL_ADD; $messageText = 'Масса съеденного (г):'; $previousKeyboard = $keyboardBackOnly; } }
                    elseif ($currentState >= STATE_AWAITING_PROTEIN_MANUAL_ADD && $currentState <= STATE_AWAITING_KCAL_MANUAL_ADD) { $previousState = $currentState - 1; $promptKey = match($previousState) { STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD => 'grams', STATE_AWAITING_PROTEIN_MANUAL_ADD => 'name', STATE_AWAITING_FAT_MANUAL_ADD => 'protein', STATE_AWAITING_CARBS_MANUAL_ADD => 'fat', default => null }; $prevValue = $userSelections[$chatId]['diary_entry'][$promptKey] ?? '?'; $messageText = match($previousState) { STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD => "Граммы: {$prevValue}\nНазвание:", STATE_AWAITING_PROTEIN_MANUAL_ADD => "Название: {$prevValue}\nБелки(г):", STATE_AWAITING_FAT_MANUAL_ADD => "Белки: {$prevValue}г\nЖиры(г):", STATE_AWAITING_CARBS_MANUAL_ADD => "Жиры: {$prevValue}г\nУглеводы(г):", default => 'Введите пред. значение:' }; $keyToRemove = match($currentState){ STATE_AWAITING_PROTEIN_MANUAL_ADD=>'name', STATE_AWAITING_FAT_MANUAL_ADD=>'protein', STATE_AWAITING_CARBS_MANUAL_ADD=>'fat', STATE_AWAITING_KCAL_MANUAL_ADD=>'carbs', default=>null}; if ($keyToRemove) unset($userSelections[$chatId]['diary_entry'][$keyToRemove]); $previousKeyboard = $keyboardBackOnly; }
                    elseif ($currentState === STATE_AWAITING_ADD_MEAL_CONFIRM_SEARCH || $currentState === STATE_AWAITING_ADD_MEAL_CONFIRM_MANUAL) { $previousState = STATE_AWAITING_ADD_MEAL_OPTION; $previousKeyboard = $keyboardAddMealOptions; $messageText = 'Запись отменена.'; }
                    elseif ($currentState === STATE_AWAITING_DATE_DELETE_MEAL || $currentState === STATE_AWAITING_DATE_VIEW_MEAL) { $previousState = STATE_DIARY_MENU; $previousKeyboard = $keyboardDiaryMenu; $messageText = 'Возврат в меню Дневника.'; }
                    elseif ($currentState === STATE_AWAITING_PRODUCT_NAME_DELETE_MEAL) { $previousState = STATE_AWAITING_DATE_DELETE_MEAL; $messageText = 'Дата (ДД.ММ.ГГГГ):'; $previousKeyboard = $keyboardBackOnly; }
                    elseif ($currentState === STATE_AWAITING_GRAMS_DELETE_MEAL) { $previousState = STATE_AWAITING_PRODUCT_NAME_DELETE_MEAL; $messageText = 'Название продукта для удаления:'; $previousKeyboard = $keyboardBackOnly; }
                    elseif ($currentState === STATE_AWAITING_DELETE_MEAL_CONFIRM) { $previousState = STATE_DIARY_MENU; $previousKeyboard = $keyboardDiaryMenu; $messageText = 'Удаление отменено.'; }
                    $userStates[$chatId] = $previousState; if (in_array($currentState, [STATE_AWAITING_ADD_MEAL_CONFIRM_MANUAL, STATE_AWAITING_ADD_MEAL_CONFIRM_SEARCH, STATE_AWAITING_DELETE_MEAL_CONFIRM, STATE_AWAITING_DATE_DELETE_MEAL, STATE_AWAITING_DATE_VIEW_MEAL])) { unset($userSelections[$chatId]['diary_entry']); unset($userSelections[$chatId]['diary_delete']); }
                    $telegram->sendMessage(['chat_id' => $chatId, 'text' => $messageText, 'reply_markup' => $previousKeyboard]);
                    continue;
                }
                 // Если просто "Назад" в основном меню или подменю
                 if ($currentState === STATE_LOGGING_TRAINING_MENU) { $userStates[$chatId] = STATE_DEFAULT; unset($currentTrainingLog[$chatId]); unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню тренировок.', 'reply_markup' => $keyboardTrainMenu]); }
                 elseif ($currentState === STATE_DIARY_MENU) { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); }
                 elseif ($currentState === STATE_DEFAULT) { $lastBotMessage = $message->getReplyToMessage() ? $message->getReplyToMessage()->getText() : ''; if (str_contains($lastBotMessage, 'БЖУ продуктов')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); } elseif (str_contains($lastBotMessage, 'Дневник питания')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); } elseif (str_contains($lastBotMessage, 'Тренировки')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } elseif (str_contains($lastBotMessage, 'Аккаунт')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } }
                 continue; // Пропускаем остальную обработку кнопок, если это был "Назад"
            } // Конец общей обработки "Назад"

            // --- Обработка состояний регистрации ---
            if ($currentState >= STATE_AWAITING_NAME && $currentState <= STATE_AWAITING_PASSWORD) {
                 if ($currentState === STATE_AWAITING_NAME) { if ($text === 'Назад') { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Смена аккаунта отменена.', 'reply_markup' => $keyboardAccount]); } else { $userData[$chatId]['name'] = $text; $userStates[$chatId] = STATE_AWAITING_EMAIL; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Почта:', 'reply_markup' => Keyboard::remove()]); } }
                 elseif ($currentState === STATE_AWAITING_EMAIL) { $userData[$chatId]['email'] = $text; $userStates[$chatId] = STATE_AWAITING_PASSWORD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Пароль:']); }
                 elseif ($currentState === STATE_AWAITING_PASSWORD) { $hashedPassword = password_hash($text, PASSWORD_DEFAULT); if ($hashedPassword === false) { echo "Pwd hash failed for {$chatId}!\n"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка регистрации.', 'reply_markup' => $keyboard]); $userStates[$chatId] = STATE_DEFAULT; unset($userData[$chatId]); } else { $userData[$chatId]['password'] = $hashedPassword; $userStates[$chatId] = STATE_DEFAULT; $name = $userData[$chatId]['name'] ?? '?'; echo "Сохр. {$chatId}: Name={$name}, Email={$userData[$chatId]['email']}, PwdHash={$hashedPassword}\n"; saveUserData($userData, $userDataFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Готово, {$name}!", 'reply_markup' => $keyboard]); } }
                 continue;
            }

            // --- Обработка состояний БЖУ ---
            if (($currentState >= STATE_AWAITING_PRODUCT_NAME_SAVE && $currentState <= STATE_AWAITING_DELETE_CONFIRMATION) || $currentState === STATE_AWAITING_PRODUCT_NAME_SEARCH) {
                 switch ($currentState) { case STATE_AWAITING_PRODUCT_NAME_SAVE: $productName = trim($text); if (empty($productName)) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название не м.б. пустым. Введите снова или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['bju_product'] = ['name' => $productName]; $userStates[$chatId] = STATE_AWAITING_PRODUCT_PROTEIN; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Назв: {$productName}\nБелки(г/100г):", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PRODUCT_PROTEIN: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (белки) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['bju_product']['protein'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_PRODUCT_FAT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Белки: {$text}г\nЖиры(г/100г):", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PRODUCT_FAT: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (жиры) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['bju_product']['fat'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_PRODUCT_CARBS; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Жиры: {$text}г\nУглеводы(г/100г):", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PRODUCT_CARBS: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (углеводы) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['bju_product']['carbs'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_PRODUCT_KCAL; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Углеводы: {$text}г\nКалории(Ккал/100г):", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PRODUCT_KCAL: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (Ккал) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['bju_product']['kcal'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_SAVE_CONFIRMATION; $pData = $userSelections[$chatId]['bju_product']; $confirmMsg = "Сохранить продукт?\nНазвание: {$pData['name']}\nНа 100г:\nБ:{$pData['protein']} Ж:{$pData['fat']} У:{$pData['carbs']} К:{$pData['kcal']}"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_SAVE_CONFIRMATION: if ($text === 'Да') { $pData = $userSelections[$chatId]['bju_product'] ?? null; if ($pData && isset($pData['name'])) { $productNameLower = mb_strtolower($pData['name']); if (!isset($userProducts[$chatId])) $userProducts[$chatId] = []; $userProducts[$chatId][$productNameLower] = [ $pData['protein'], $pData['fat'], $pData['carbs'], $pData['kcal'] ]; saveUserProducts($userProducts, $userProductsFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$pData['name']}' сохранен!", 'reply_markup' => $keyboardBJU]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка сохранения.', 'reply_markup' => $keyboardBJU]); } $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]['bju_product']); } elseif ($text === 'Нет') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сохранение отменено.', 'reply_markup' => $keyboardBJU]); $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]['bju_product']); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Пожалуйста, нажмите "Да" или "Нет".', 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_PRODUCT_NAME_DELETE: $productName = trim(mb_strtolower($text)); if (isset($userProducts[$chatId][$productName])) { $pData = $userProducts[$chatId][$productName]; $userSelections[$chatId]['bju_product_to_delete'] = $productName; $userStates[$chatId] = STATE_AWAITING_DELETE_CONFIRMATION; $confirmMsg = "Найдено: {$productName}\nБ: {$pData[0]} Ж: {$pData[1]} У: {$pData[2]} К: {$pData[3]}\nУдалить?"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$text}' не найден. Введите снова или 'Назад'.", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_DELETE_CONFIRMATION: if ($text === 'Да') { $productNameToDelete = $userSelections[$chatId]['bju_product_to_delete'] ?? null; if ($productNameToDelete && isset($userProducts[$chatId][$productNameToDelete])) { unset($userProducts[$chatId][$productNameToDelete]); saveUserProducts($userProducts, $userProductsFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$productNameToDelete}' удален.", 'reply_markup' => $keyboardBJU]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка удаления.', 'reply_markup' => $keyboardBJU]); } $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]['bju_product_to_delete']); } elseif ($text === 'Нет') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Удаление отменено.', 'reply_markup' => $keyboardBJU]); $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]['bju_product_to_delete']); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Пожалуйста, нажмите "Да" или "Нет".', 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_PRODUCT_NAME_SEARCH: $productName = trim(mb_strtolower($text)); if (isset($userProducts[$chatId][$productName])) { $pData = $userProducts[$chatId][$productName]; $resultMsg = "Найден: {$productName}\nБ: {$pData[0]} Ж: {$pData[1]} У: {$pData[2]} К: {$pData[3]}"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $resultMsg, 'reply_markup' => $keyboardBJU]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$text}' не найден.", 'reply_markup' => $keyboardBJU]); } $userStates[$chatId] = STATE_DEFAULT; break; }
                continue;
            }

            // --- Обработка состояний Дневника ---
            if ($currentState >= STATE_AWAITING_ADD_MEAL_OPTION && $currentState <= STATE_AWAITING_DATE_VIEW_MEAL) {
                 switch ($currentState) { case STATE_AWAITING_ADD_MEAL_OPTION: if ($text === 'Поиск в базе знаний') { if (empty($userProducts[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала сохраните продукты в "БЖУ продуктов".', 'reply_markup' => $keyboardAddMealOptions]); } else { $userStates[$chatId] = STATE_AWAITING_SEARCH_PRODUCT_NAME_ADD; $userSelections[$chatId]['diary_entry'] = ['date' => date('Y-m-d')]; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название продукта из сохраненных (или "Назад"):', 'reply_markup' => $keyboardBackOnly]); } } elseif ($text === 'Записать БЖУ самому') { $userStates[$chatId] = STATE_AWAITING_GRAMS_MANUAL_ADD; $userSelections[$chatId]['diary_entry'] = ['date' => date('Y-m-d')]; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Масса съеденного (г) (или "Назад"):', 'reply_markup' => $keyboardBackOnly]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Используйте кнопки.', 'reply_markup' => $keyboardAddMealOptions]); } break; case STATE_AWAITING_SEARCH_PRODUCT_NAME_ADD: $productName = trim(mb_strtolower($text)); if (isset($userProducts[$chatId][$productName])) { $userSelections[$chatId]['diary_entry']['search_name'] = $productName; $userStates[$chatId] = STATE_AWAITING_GRAMS_SEARCH_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$productName}' найден.\nМасса (г):", 'reply_markup' => $keyboardBackOnly]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$text}' не найден. Попробуйте снова или 'Назад'.", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_GRAMS_SEARCH_ADD: if (!is_numeric($text) || $text <= 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (граммы) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $grams = (float)$text; $productName = $userSelections[$chatId]['diary_entry']['search_name']; $baseBJU = $userProducts[$chatId][$productName]; $p = round($baseBJU[0] * $grams / 100, 1); $f = round($baseBJU[1] * $grams / 100, 1); $c = round($baseBJU[2] * $grams / 100, 1); $kcal = round($baseBJU[3] * $grams / 100, 0); $userSelections[$chatId]['diary_entry']['log'] = [ 'name' => $productName, 'grams' => $grams, 'p' => $p, 'f' => $f, 'c' => $c, 'kcal' => $kcal ]; $userStates[$chatId] = STATE_AWAITING_ADD_MEAL_CONFIRM_SEARCH; $confirmMsg = "Добавить в дневник?\n{$productName} - {$grams} г\nБ: {$p} Ж: {$f} У: {$c} К: {$kcal}"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_ADD_MEAL_CONFIRM_SEARCH: if ($text === 'Да') { $logData = $userSelections[$chatId]['diary_entry']['log'] ?? null; $logDate = $userSelections[$chatId]['diary_entry']['date'] ?? date('Y-m-d'); if ($logData) { if (!isset($diaryData[$chatId])) $diaryData[$chatId] = []; if (!isset($diaryData[$chatId][$logDate])) $diaryData[$chatId][$logDate] = []; $diaryData[$chatId][$logDate][] = $logData; saveDiaryData($diaryData, $diaryFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "'{$logData['name']}' ({$logData['grams']}г) записано на {$logDate}.", 'reply_markup' => $keyboardDiaryMenu]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка записи.', 'reply_markup' => $keyboardDiaryMenu]); } $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_entry']); } elseif ($text === 'Нет') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Запись отменена.', 'reply_markup' => $keyboardDiaryMenu]); $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_entry']); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нажмите "Да" или "Нет".', 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_GRAMS_MANUAL_ADD: if (!is_numeric($text) || $text <= 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите полож. число (граммы) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['grams'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Граммы: {$text}г\nНазвание продукта:", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PRODUCT_NAME_MANUAL_ADD: $productName = trim($text); if (empty($productName)) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название не м.б. пустым. Введите снова или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['name'] = $productName; $userStates[$chatId] = STATE_AWAITING_PROTEIN_MANUAL_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Название: {$productName}\nБелки(г) в порции:", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_PROTEIN_MANUAL_ADD: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (белки) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['p'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_FAT_MANUAL_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Белки: {$text}г\nЖиры(г) в порции:", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_FAT_MANUAL_ADD: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (жиры) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['f'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_CARBS_MANUAL_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Жиры: {$text}г\nУглеводы(г) в порции:", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_CARBS_MANUAL_ADD: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (углеводы) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['c'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_KCAL_MANUAL_ADD; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Углеводы: {$text}г\nКалории(Ккал) в порции:", 'reply_markup' => $keyboardBackOnly]); } break; case STATE_AWAITING_KCAL_MANUAL_ADD: if (!is_numeric($text) || $text < 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (Ккал) или "Назад".', 'reply_markup' => $keyboardBackOnly]); } else { $userSelections[$chatId]['diary_entry']['kcal'] = (float)$text; $userStates[$chatId] = STATE_AWAITING_ADD_MEAL_CONFIRM_MANUAL; $dData = $userSelections[$chatId]['diary_entry']; $confirmMsg = "Добавить в дневник?\n{$dData['name']} - {$dData['grams']} г\nБ: {$dData['p']} Ж: {$dData['f']} У: {$dData['c']} К: {$dData['kcal']}"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } break; case STATE_AWAITING_ADD_MEAL_CONFIRM_MANUAL: if ($text === 'Да') { $logData = $userSelections[$chatId]['diary_entry'] ?? null; $logDate = $userSelections[$chatId]['diary_entry']['date'] ?? date('Y-m-d'); if ($logData && isset($logData['name'])) { unset($logData['date']); if (!isset($diaryData[$chatId])) $diaryData[$chatId] = []; if (!isset($diaryData[$chatId][$logDate])) $diaryData[$chatId][$logDate] = []; $diaryData[$chatId][$logDate][] = $logData; saveDiaryData($diaryData, $diaryFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "'{$logData['name']}' ({$logData['grams']}г) записано на {$logDate}.", 'reply_markup' => $keyboardDiaryMenu]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка записи.', 'reply_markup' => $keyboardDiaryMenu]); } $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_entry']); } elseif ($text === 'Нет') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Запись отменена.', 'reply_markup' => $keyboardDiaryMenu]); $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_entry']); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нажмите "Да" или "Нет".', 'reply_markup' => $keyboardConfirmYesNo]); } break;
                case STATE_AWAITING_DATE_DELETE_MEAL: $dateToDelete = date('Y-m-d'); if (strtolower($text) === 'вчера') { $dateToDelete = date('Y-m-d', strtotime('-1 day')); } elseif (preg_match('/^(\d{2})\.(\d{2})\.(\d{4})$/', $text, $matches)) { if (checkdate($matches[2], $matches[1], $matches[3])) { $dateToDelete = "{$matches[3]}-{$matches[2]}-{$matches[1]}"; } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорр. дата.', 'reply_markup' => $keyboardBackOnly]); break; } } elseif (strtolower($text) !== 'сегодня') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорр. формат.', 'reply_markup' => $keyboardBackOnly]); break; } if (empty($diaryData[$chatId][$dateToDelete])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Нет записей за {$dateToDelete}.", 'reply_markup' => $keyboardDiaryMenu]); $userStates[$chatId] = STATE_DIARY_MENU; break; } $userSelections[$chatId]['diary_delete'] = ['date' => $dateToDelete]; $userStates[$chatId] = STATE_AWAITING_PRODUCT_NAME_DELETE_MEAL; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Дата: {$dateToDelete}\nНазвание продукта для удаления:", 'reply_markup' => $keyboardBackOnly]); break;
                case STATE_AWAITING_PRODUCT_NAME_DELETE_MEAL: $productName = trim($text); $dateToDelete = $userSelections[$chatId]['diary_delete']['date']; $foundEntries = []; if (!empty($diaryData[$chatId][$dateToDelete])) { foreach ($diaryData[$chatId][$dateToDelete] as $index => $entry) { if (mb_strtolower($entry['name']) === mb_strtolower($productName)) { $foundEntries[$index] = $entry; } } } if (count($foundEntries) === 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Продукт '{$productName}' не найден за {$dateToDelete}. Попробуйте снова или 'Назад'.", 'reply_markup' => $keyboardBackOnly]); } elseif (count($foundEntries) === 1) { $indexToDelete = key($foundEntries); $entryToDelete = current($foundEntries); $userSelections[$chatId]['diary_delete']['index'] = $indexToDelete; $userSelections[$chatId]['diary_delete']['entry'] = $entryToDelete; $userStates[$chatId] = STATE_AWAITING_DELETE_MEAL_CONFIRM; $confirmMsg = "Удалить запись?\n{$dateToDelete}: {$entryToDelete['name']} {$entryToDelete['grams']}г (Б:{$entryToDelete['p']} Ж:{$entryToDelete['f']} У:{$entryToDelete['c']} К:{$entryToDelete['kcal']})"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } else { $userSelections[$chatId]['diary_delete']['name'] = $productName; $userStates[$chatId] = STATE_AWAITING_GRAMS_DELETE_MEAL; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Неск. записей '{$productName}' за {$dateToDelete}. Введите точную граммовку:", 'reply_markup' => $keyboardBackOnly]); } break;
                case STATE_AWAITING_GRAMS_DELETE_MEAL: if (!is_numeric($text) || $text <= 0) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорректно. Введите число (граммы) или "Назад".', 'reply_markup' => $keyboardBackOnly]); break; } $grams = (float)$text; $productName = $userSelections[$chatId]['diary_delete']['name']; $dateToDelete = $userSelections[$chatId]['diary_delete']['date']; $foundIndex = null; $entryToDelete = null; if (!empty($diaryData[$chatId][$dateToDelete])) { foreach ($diaryData[$chatId][$dateToDelete] as $index => $entry) { if (mb_strtolower($entry['name']) === mb_strtolower($productName) && abs($entry['grams'] - $grams) < 0.01) { $foundIndex = $index; $entryToDelete = $entry; break; } } } if ($foundIndex !== null) { $userSelections[$chatId]['diary_delete']['index'] = $foundIndex; $userSelections[$chatId]['diary_delete']['entry'] = $entryToDelete; $userStates[$chatId] = STATE_AWAITING_DELETE_MEAL_CONFIRM; $confirmMsg = "Удалить запись?\n{$dateToDelete}: {$entryToDelete['name']} {$entryToDelete['grams']}г (Б:{$entryToDelete['p']} Ж:{$entryToDelete['f']} У:{$entryToDelete['c']} К:{$entryToDelete['kcal']})"; $telegram->sendMessage(['chat_id' => $chatId, 'text' => $confirmMsg, 'reply_markup' => $keyboardConfirmYesNo]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Запись '{$productName}' {$grams}г не найдена за {$dateToDelete}. Попробуйте граммовку снова или 'Назад'.", 'reply_markup' => $keyboardBackOnly]); } break;
                case STATE_AWAITING_DELETE_MEAL_CONFIRM: if ($text === 'Да') { $dateToDelete = $userSelections[$chatId]['diary_delete']['date'] ?? null; $indexToDelete = $userSelections[$chatId]['diary_delete']['index'] ?? null; $entryName = $userSelections[$chatId]['diary_delete']['entry']['name'] ?? '???'; if ($dateToDelete && $indexToDelete !== null && isset($diaryData[$chatId][$dateToDelete][$indexToDelete])) { unset($diaryData[$chatId][$dateToDelete][$indexToDelete]); if (empty($diaryData[$chatId][$dateToDelete])) { unset($diaryData[$chatId][$dateToDelete]); } if (empty($diaryData[$chatId])) { unset($diaryData[$chatId]); } saveDiaryData($diaryData, $diaryFile); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Запись '{$entryName}' за {$dateToDelete} удалена.", 'reply_markup' => $keyboardDiaryMenu]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка удаления.', 'reply_markup' => $keyboardDiaryMenu]); } $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_delete']); } elseif ($text === 'Нет') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Удаление отменено.', 'reply_markup' => $keyboardDiaryMenu]); $userStates[$chatId] = STATE_DIARY_MENU; unset($userSelections[$chatId]['diary_delete']); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нажмите "Да" или "Нет".', 'reply_markup' => $keyboardConfirmYesNo]); } break;
                case STATE_AWAITING_DATE_VIEW_MEAL: $dateToView = date('Y-m-d'); if (strtolower($text) === 'вчера') { $dateToView = date('Y-m-d', strtotime('-1 day')); } elseif (preg_match('/^(\d{2})\.(\d{2})\.(\d{4})$/', $text, $matches)) { if (checkdate($matches[2], $matches[1], $matches[3])) { $dateToView = "{$matches[3]}-{$matches[2]}-{$matches[1]}"; } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорр. дата.', 'reply_markup' => $keyboardBackOnly]); break; } } elseif (strtolower($text) !== 'сегодня') { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Некорр. формат.', 'reply_markup' => $keyboardBackOnly]); break; } if (empty($diaryData[$chatId][$dateToView])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Нет записей за {$dateToView}.", 'reply_markup' => $keyboardDiaryMenu]); } else { $totalP = 0; $totalF = 0; $totalC = 0; $totalKcal = 0; $viewMsg = "Рацион за {$dateToView}:\n\n"; $i = 1; foreach ($diaryData[$chatId][$dateToView] as $entry) { $viewMsg .= "{$i}. {$entry['name']} ({$entry['grams']} г)\n   Б:{$entry['p']} Ж:{$entry['f']} У:{$entry['c']} К:{$entry['kcal']}\n"; $totalP += $entry['p']; $totalF += $entry['f']; $totalC += $entry['c']; $totalKcal += $entry['kcal']; $i++; } $viewMsg .= "\nИтого: Б:".round($totalP,1)." Ж:".round($totalF,1)." У:".round($totalC,1)." К:".round($totalKcal); $telegram->sendMessage(['chat_id' => $chatId, 'text' => $viewMsg, 'reply_markup' => $keyboardDiaryMenu]); } $userStates[$chatId] = STATE_DIARY_MENU; break;
            } // Конец switch ($currentState) для Дневника
            continue; // Пропускаем остальную обработку
        } // Конец if для Дневника

            // --- ОБЩАЯ Обработка состояний выбора упражнения ---
            if ($currentState >= STATE_SELECTING_MUSCLE_GROUP && $currentState <= STATE_SELECTING_EXERCISE) {
                // ... (код выбора упражнения) ...
                 if (!ctype_digit($text)) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Введите номер или "Назад".', 'reply_markup' => $keyboardBackOnly]); continue; } $choiceIndex = (int)$text - 1; switch ($currentState) { case STATE_SELECTING_MUSCLE_GROUP: $groupKeys = array_keys($exercises); if (isset($groupKeys[$choiceIndex])) { $selectedGroup = $groupKeys[$choiceIndex]; $userSelections[$chatId]['group'] = $selectedGroup; $userStates[$chatId] = STATE_SELECTING_EXERCISE_TYPE; $typeKeys = isset($exercises[$selectedGroup]) ? array_keys($exercises[$selectedGroup]) : []; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Группа: {$selectedGroup}\nВыберите тип:\n" . generateListMessage($typeKeys), 'reply_markup' => $keyboardBackOnly]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Неверный номер.', 'reply_markup' => $keyboardBackOnly]); } break; case STATE_SELECTING_EXERCISE_TYPE: $group = $userSelections[$chatId]['group'] ?? null; if (!$group) { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка. Начните заново.', 'reply_markup' => $keyboard]); break; } $typeKeys = isset($exercises[$group]) ? array_keys($exercises[$group]) : []; if (isset($typeKeys[$choiceIndex])) { $selectedType = $typeKeys[$choiceIndex]; $userSelections[$chatId]['type'] = $selectedType; $userStates[$chatId] = STATE_SELECTING_EXERCISE; $exerciseList = isset($exercises[$group][$selectedType]) ? $exercises[$group][$selectedType] : []; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Тип: {$selectedType}\nВыберите упражнение:\n" . generateListMessage($exerciseList), 'reply_markup' => $keyboardBackOnly]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Неверный номер.', 'reply_markup' => $keyboardBackOnly]); } break; case STATE_SELECTING_EXERCISE: $group = $userSelections[$chatId]['group'] ?? null; $type = $userSelections[$chatId]['type'] ?? null; $mode = $userSelections[$chatId]['mode'] ?? null; if (!$group || !$type || !$mode) { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Ошибка. Начните заново.', 'reply_markup' => $keyboard]); break; } $exerciseList = isset($exercises[$group][$type]) ? $exercises[$group][$type] : []; if (isset($exerciseList[$choiceIndex])) { $selectedExercise = $exerciseList[$choiceIndex]; if ($mode === 'log') { $userSelections[$chatId]['exercise'] = $selectedExercise; $userStates[$chatId] = STATE_AWAITING_REPS; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Упражнение: {$selectedExercise}\nПовторения:", 'reply_markup' => $keyboardBackOnly]); } elseif ($mode === 'view') { $userStates[$chatId] = STATE_DEFAULT; unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Упражнение: {$selectedExercise}\nВаши результаты:\n(пока пусто)", 'reply_markup' => $keyboardTrainMenu]); } else { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Внутренняя ошибка режима.', 'reply_markup' => $keyboard]); } } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Неверный номер.', 'reply_markup' => $keyboardBackOnly]); } break; }
                continue;
            }

            // --- Обработка состояний ТОЛЬКО для записи (повторы, вес) ---
            if ($currentState === STATE_AWAITING_REPS || $currentState === STATE_AWAITING_WEIGHT) {
                // ... (код ввода повторов/веса) ...
                 if ($currentState === STATE_AWAITING_REPS) { $userSelections[$chatId]['reps'] = $text; $userStates[$chatId] = STATE_AWAITING_WEIGHT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Повторения: {$text}\nВес:", 'reply_markup' => $keyboardBackOnly]); } elseif ($currentState === STATE_AWAITING_WEIGHT) { $userSelections[$chatId]['weight'] = $text; $logEntry = ['exercise' => $userSelections[$chatId]['exercise'] ?? '???', 'reps' => $userSelections[$chatId]['reps'] ?? '???', 'weight' => $userSelections[$chatId]['weight'] ?? '???',]; if (!isset($currentTrainingLog[$chatId])) $currentTrainingLog[$chatId] = []; $currentTrainingLog[$chatId][] = $logEntry; echo "Добавлено в лог для $chatId: "; print_r($logEntry); echo "\n"; $exerciseName = $logEntry['exercise']; unset($userSelections[$chatId]); $userStates[$chatId] = STATE_LOGGING_TRAINING_MENU; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Упражнение '{$exerciseName}' добавлено!\nДобавить еще?", 'reply_markup' => $keyboardAddExerciseMenu]); }
                continue;
            }


            // --- Обработка команд и кнопок (состояние STATE_DEFAULT, STATE_LOGGING_TRAINING_MENU, STATE_DIARY_MENU) ---
            switch ($text) {
                // --- Основные команды и Аккаунт ---
                case '/start': if (isset($userData[$chatId])) { $name = $userData[$chatId]['name'] ?? '?'; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "С возвращением, {$name}!", 'reply_markup' => $keyboard]); } else { $userStates[$chatId] = STATE_AWAITING_NAME; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Введите имя:", 'reply_markup' => Keyboard::remove()]); } break;
                case 'Аккаунт': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Аккаунт:', 'reply_markup' => $keyboardAccount]); break;
                case 'Вывести имя и почту': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Данные не найдены.']); break; } $name = $userData[$chatId]['name'] ?? 'Не указ.'; $email = $userData[$chatId]['email'] ?? 'Не указ.'; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Имя: {$name}\nПочта: {$email}", 'reply_markup' => $keyboardAccount]); break;
                case 'Сменить аккаунт': if ($currentState !== STATE_DEFAULT) break; $userStates[$chatId] = STATE_AWAITING_NAME; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Введите имя (или 'Назад'):", 'reply_markup' => $keyboardBackOnly]); break;

                // --- Меню Тренировки и его подпункты ---
                case 'Тренировки': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Тренировки:', 'reply_markup' => $keyboardTrainMenu]); break;
                case 'Записать тренировку': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_LOGGING_TRAINING_MENU; $currentTrainingLog[$chatId] = []; unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Запись тренировки:', 'reply_markup' => $keyboardAddExerciseMenu]); break;
                case 'Посмотреть прогресс в упражнениях': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_SELECTING_MUSCLE_GROUP; $userSelections[$chatId] = ['mode' => 'view']; $groupKeys = array_keys($exercises); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Для просмотра прогресса, выберите группу:\n" . generateListMessage($groupKeys), 'reply_markup' => $keyboardBackOnly]); break;
                case 'Вывести отстающие группы мышц': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => "У тебя все отстающее, иди качаться дрищ!", 'reply_markup' => $keyboardTrainMenu]); break;

                // --- Кнопки меню Записи Тренировки ---
                case 'Добавить упражнение': if ($currentState !== STATE_LOGGING_TRAINING_MENU) break; $userStates[$chatId] = STATE_SELECTING_MUSCLE_GROUP; $userSelections[$chatId] = ['mode' => 'log']; $groupKeys = array_keys($exercises); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Выберите группу:\n" . generateListMessage($groupKeys), 'reply_markup' => $keyboardBackOnly]); break;
                case 'Завершить запись тренировки': if ($currentState !== STATE_LOGGING_TRAINING_MENU) break; $logCount = isset($currentTrainingLog[$chatId]) ? count($currentTrainingLog[$chatId]) : 0; if ($logCount > 0) { $userStates[$chatId] = STATE_DEFAULT; echo "Завершение $chatId ($logCount упр.): "; print_r($currentTrainingLog[$chatId]); echo "\n"; /* Сохранение лога */ unset($currentTrainingLog[$chatId]); unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Тренировка записана ({$logCount} упр.).", 'reply_markup' => $keyboard]); } else { $userStates[$chatId] = STATE_DEFAULT; unset($currentTrainingLog[$chatId]); unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Не добавлено упр. Возврат в меню.', 'reply_markup' => $keyboard]); } break;

                // --- Меню Питание и его подпункты ---
                case 'Питание': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Выберите раздел Питания:', 'reply_markup' => $keyboardNutrition]); break;
                case 'Дневник': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_DIARY_MENU; $telegram->sendMessage(['chat_id' => $chatId, 'text' => "Дневник питания:", 'reply_markup' => $keyboardDiaryMenu]); break;
                case 'БЖУ продуктов': if ($currentState !== STATE_DEFAULT) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Выберите действие с БЖУ продуктов:', 'reply_markup' => $keyboardBJU]); break;

                // --- Кнопки меню Дневника ---
                case 'Записать приём пищи': if ($currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_AWAITING_ADD_MEAL_OPTION; unset($userSelections[$chatId]['diary_entry']); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Как добавить прием пищи?', 'reply_markup' => $keyboardAddMealOptions]); break;
                case 'Удалить приём пищи': if ($currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } if (!isset($diaryData[$chatId]) || empty($diaryData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Дневник пока пуст.', 'reply_markup' => $keyboardDiaryMenu]); break; } $userStates[$chatId] = STATE_AWAITING_DATE_DELETE_MEAL; unset($userSelections[$chatId]['diary_delete']); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Дата удаления (ДД.ММ.ГГГГ, сегодня, вчера) или "Назад":', 'reply_markup' => $keyboardBackOnly]); break;
                case 'Посмотреть рацион за дату': if ($currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_AWAITING_DATE_VIEW_MEAL; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Дата просмотра (ДД.ММ.ГГГГ, сегодня, вчера) или "Назад":', 'reply_markup' => $keyboardBackOnly]); break;

                // --- Кнопки подменю БЖУ ---
                case 'Сохранить информацию о продукте': if ($currentState !== STATE_DEFAULT && $currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } $userStates[$chatId] = STATE_AWAITING_PRODUCT_NAME_SAVE; unset($userSelections[$chatId]['bju_product']); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название продукта (или "Назад"):', 'reply_markup' => $keyboardBackOnly]); break;
                case 'Удалить информацию о продукте': if ($currentState !== STATE_DEFAULT && $currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } if (!isset($userProducts[$chatId]) || empty($userProducts[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нет сохраненных продуктов.', 'reply_markup' => $keyboardBJU]); break; } $userStates[$chatId] = STATE_AWAITING_PRODUCT_NAME_DELETE; unset($userSelections[$chatId]['bju_product_to_delete']); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название продукта для удаления (или "Назад"):', 'reply_markup' => $keyboardBackOnly]); break;
                case 'Сохранённые продукты': if ($currentState !== STATE_DEFAULT && $currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } if (!isset($userProducts[$chatId]) || empty($userProducts[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нет сохраненных продуктов.', 'reply_markup' => $keyboardBJU]); } else { $productListMsg = "Сохраненные продукты:\n"; $i = 1; foreach ($userProducts[$chatId] as $name => $bju) { $productListMsg .= "{$i}. {$name} (Б:{$bju[0]} Ж:{$bju[1]} У:{$bju[2]} К:{$bju[3]})\n"; $i++; } $telegram->sendMessage(['chat_id' => $chatId, 'text' => rtrim($productListMsg), 'reply_markup' => $keyboardBJU]); } break;
                case 'Поиск продуктов': if ($currentState !== STATE_DEFAULT && $currentState !== STATE_DIARY_MENU) break; if (!isset($userData[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Сначала войдите (/start).']); break; } if (!isset($userProducts[$chatId]) || empty($userProducts[$chatId])) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Нет сохраненных продуктов.', 'reply_markup' => $keyboardBJU]); break; } $userStates[$chatId] = STATE_AWAITING_PRODUCT_NAME_SEARCH; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Название продукта для поиска (или "Назад"):', 'reply_markup' => $keyboardBackOnly]); break;

                // --- Кнопка "Назад" (из ГЛАВНЫХ подменю) ---
                case 'Назад':
                    if ($currentState === STATE_LOGGING_TRAINING_MENU) { $userStates[$chatId] = STATE_DEFAULT; unset($currentTrainingLog[$chatId]); unset($userSelections[$chatId]); $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню тренировок.', 'reply_markup' => $keyboardTrainMenu]); }
                    elseif ($currentState === STATE_DIARY_MENU) { $userStates[$chatId] = STATE_DEFAULT; $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); }
                    elseif ($currentState === STATE_DEFAULT) { $lastBotMessage = $message->getReplyToMessage() ? $message->getReplyToMessage()->getText() : ''; if (str_contains($lastBotMessage, 'БЖУ продуктов')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); } elseif (str_contains($lastBotMessage, 'Дневник питания')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Возврат в меню Питания.', 'reply_markup' => $keyboardNutrition]); } elseif (str_contains($lastBotMessage, 'Тренировки')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } elseif (str_contains($lastBotMessage, 'Аккаунт')) { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } else { $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Главное меню.', 'reply_markup' => $keyboard]); } }
                    break;

                 // --- Обработка неизвестного текста ---
                 // default:
                 //     if ($currentState === STATE_DEFAULT || $currentState === STATE_DIARY_MENU || $currentState === STATE_LOGGING_TRAINING_MENU) {
                 //         $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Неизвестная команда. Используйте кнопки.']);
                 //     }
                 //     // Если в другом состоянии, то он обрабатывается выше
                 //     break;

            } // Конец switch

        } catch (\Throwable $e) {
            echo "Error processing message for chat ID {$chatId}: " . $e->getMessage() . "\n";
            echo $e->getTraceAsString() . "\n";
            try {
                 $telegram->sendMessage(['chat_id' => $chatId, 'text' => 'Произошла ошибка.']);
                 $userStates[$chatId] = STATE_DEFAULT;
                 unset($userSelections[$chatId]);
            } catch (\Throwable $e) {
                 echo "Could not send error message to user {$chatId}.\n";
            }
        }

    } // Конец foreach updates
    sleep(1);
} // Конец while true